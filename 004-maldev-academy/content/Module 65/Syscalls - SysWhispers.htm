<!DOCTYPE html>
<html class="dark"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie-edge">
        <meta name="csrf-token" content="YwmJrjvrFLFoheCqdySsfQHrDWEGzxTLXO7qfost">
        <link rel="stylesheet" href="Syscalls%20-%20SysWhispers_files/template.css">
        <link rel="shortcut icon" href="https://maldevacademy.com/favicon.ico">
        <!-- fontawesome for icons -->
        <link rel="stylesheet" href="Syscalls%20-%20SysWhispers_files/font-awesome.min.css">
        <!-- google fonts -->
        <link rel="preconnect" href="https://fonts.gstatic.com/">
        <link href="Syscalls%20-%20SysWhispers_files/css2.css" rel="stylesheet">
        <link href="Syscalls%20-%20SysWhispers_files/css2_002.css" rel="stylesheet">
        <title>Syscalls - SysWhispers</title>
        <!-- Custom css files, order matters -->
        <link rel="preload" as="style" href="Syscalls%20-%20SysWhispers_files/app.fdbb573b.css"><link rel="stylesheet" href="Syscalls%20-%20SysWhispers_files/app.fdbb573b.css"><link rel="stylesheet" href="Syscalls%20-%20SysWhispers_files/viewer.css">
    </head>
    <body>
        <nav id="navbar" class="px-2 sm:px-4 py-2.5 bg-gray-900 sticky hidden">
    <div class="container flex flex-wrap justify-between mx-auto">
      <a data-target="_self" href="https://maldevacademy.com/" class="flex items-center">
        <div class="main-logo flex flex-row items-center">
            <span class="text-xl logo-font text-white">MALDEV</span>
            <img class="w-[25px] mx-2 relative bottom-1" src="Syscalls%20-%20SysWhispers_files/logo-bug-2.png" alt="Logo">   
            <span class="text-xl logo-font text-white">ACADEMY</span>          
        </div>
      </a>
      <button data-collapse-toggle="navbar-default" id="navbar-phone-btn" type="button" class="inline-flex items-center p-2 ml-3 text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-default" aria-expanded="false">
        <span class="sr-only">Open main menu</span>
        <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
      </button>
      <div class="hidden w-full md:block md:w-auto" id="navbar-default">
        <ul class="flex flex-col items-center p-4 mt-4 bg-gray-50 rounded-lg border border-gray-100 md:flex-row md:space-x-8 md:mt-0 md:text-sm md:font-medium md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
          <li>
            <a data-target="_self" href="https://maldevacademy.com/" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Home</a>
          </li>
          <li>
            <a data-target="_self" href="https://maldevacademy.com/faq" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">FAQ</a>
          </li>
          <li>
            <a data-target="_self" href="https://maldevacademy.com/syllabus" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Syllabus</a>
          </li>
                              <li>
            <a data-target="_self" href="https://maldevacademy.com/pricing" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Pricing</a>
          </li>
                                        <li>
            <a data-target="_self" href="https://maldevacademy.com/profile" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Profile</a>
          </li>
          <li>
            <form action="https://maldevacademy.com/logout" method="POST">
            <input type="hidden" name="_token" value="YwmJrjvrFLFoheCqdySsfQHrDWEGzxTLXO7qfost">              <button type="submit" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Logout</button>
            </form>
          </li>
          <li class="mt-4 md:mt-0">
            <a data-target="_self" href="https://maldevacademy.com/modules" class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center md:mr-3 mr-0 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Modules</a>
          </li>
                  </ul>
      </div>
    </div>
  </nav>        <div class="bg-gray-900 p-4">
    <div class="flex">
        <div class="md:flex-row flex-col flex md:items-center w-1/2 bg-gray-700 border-l border-t border-gray-600 pl-4 pt-2 pb-2 rounded-tl">
            <div>
                Module 65 - Syscalls - SysWhispers
            </div>
            <div class="ml-2 w-4 h-4 bg-orange-600 rounded-full"></div>
        </div>
        <div class="flex justify-end items-center w-1/2 bg-gray-700 pr-4 pt-2 pb-2 rounded-tr border-t border-r border-gray-600">
            <div class="enlarge-container pr-4">
                <img src="Syscalls%20-%20SysWhispers_files/enlarge.svg" onclick="toggleScreenWidth()" class="hover:bg-gray-600 rounded-sm cursor-pointer" id="enlargeToggle" alt="Screen Width" width="20px">
            </div>
            <div class="objectives-container pr-4">
                <img src="Syscalls%20-%20SysWhispers_files/objectives.svg" onclick="toggleObjectives()" class="hover:bg-gray-600 cursor-pointer" id="objectivesToggle" alt="Objectives" width="20px">
            </div>
            <div class="terminal-container ">
                <img src="Syscalls%20-%20SysWhispers_files/ide.svg" onclick="toggleIde()" class="hover:bg-gray-600 rounded-sm cursor-pointer" id="terminalToggle" alt="Terminal" width="22px">
            </div>
                    </div>
    </div>
    <div id="height-container" class="flex h-full min-h-[800px]">
        <div class="flex max-w-full min-w-full">
            <div id="description-container" class="viewer code-description h-full bg-gray-800 p-4 border-r border-l border-b border-gray-600 px-5 md:px-10 lg:px-20 w-full"><div class="toastui-editor-contents" style="overflow-wrap: break-word;">
            <h2>Syscalls - SysWhispers</h2>
<h3>Introduction</h3>
<p>SysWhispers is a tool that evades syscalls hooking via direct 
syscalls. There are several versions of SysWhispers which have different
 features. The difference between the versions will be discussed in this
 module.</p>
<h3>SysWhispers</h3>
<p><a href="https://github.com/jthuraisamy/SysWhispers" target="_blank">SysWhispers</a>
 generates header/ASM file implants to enable direct system calls on 
64-bit systems. It supports syscalls from Windows XP to Windows 10 19042
 (20H2). The supported Windows versions are limited since the syscall 
number (SSN) can be altered with each Windows update. Therefore, a 
direct syscall implementation for a particular syscall on Windows 10 
1903 may not be compatible with the same syscall on Windows 10 1909, and
 vice versa.</p>
<p>Since the same syscalls may have different SSNs on different versions
 of Windows, SysWhispers checks the Windows version of the target system
 at runtime and sets the SSN manually to the correct version.</p>
<h3>SysWhispers - NtMapViewOfSection Example</h3>
<p>SysWhispers uses a Python script to generate two files (<a href="https://github.com/jthuraisamy/SysWhispers/tree/master/example-output" target="_blank">example</a>). The SSNs are derived from the <a href="https://j00ru.vexillium.org/syscalls/nt/64/" target="_blank">Windows X86-64 System Call Table</a> and are hardcoded into the created assembly file. The assembly functions then determine which SSN to use.</p>
<h4>SysWhispers Sample Output</h4>
<p>The assembly functions below are derived when SysWhispers is used to generate direct syscalls for <code>NtMapViewOfSection</code>.</p>
<pre><code>// ...

NtMapViewOfSection PROC
	mov rax, gs:[60h]                             ; Load PEB into RAX.
NtMapViewOfSection_Check_X_X_XXXX:                ; Check major version.
	cmp dword ptr [rax+118h], 5
	je  NtMapViewOfSection_SystemCall_5_X_XXXX
	cmp dword ptr [rax+118h], 6
	je  NtMapViewOfSection_Check_6_X_XXXX
	cmp dword ptr [rax+118h], 10
	je  NtMapViewOfSection_Check_10_0_XXXX
	jmp NtMapViewOfSection_SystemCall_Unknown
NtMapViewOfSection_Check_6_X_XXXX:               ; Check minor version for Windows Vista/7/8.
	cmp dword ptr [rax+11ch], 0
	je  NtMapViewOfSection_Check_6_0_XXXX
	cmp dword ptr [rax+11ch], 1
	je  NtMapViewOfSection_Check_6_1_XXXX
	cmp dword ptr [rax+11ch], 2
	je  NtMapViewOfSection_SystemCall_6_2_XXXX
	cmp dword ptr [rax+11ch], 2
	je  NtMapViewOfSection_SystemCall_6_3_XXXX
	jmp NtMapViewOfSection_SystemCall_Unknown
NtMapViewOfSection_Check_6_0_XXXX:               ; Check build number for Windows Vista.
	cmp dword ptr [rax+120h], 6000
	je  NtMapViewOfSection_SystemCall_6_0_6000
	cmp dword ptr [rax+120h], 6001
	je  NtMapViewOfSection_SystemCall_6_0_6001
	cmp dword ptr [rax+120h], 6002
	je  NtMapViewOfSection_SystemCall_6_0_6002
	jmp NtMapViewOfSection_SystemCall_Unknown
NtMapViewOfSection_Check_6_1_XXXX:               ; Check build number for Windows 7.
	cmp dword ptr [rax+120h], 7600
	je  NtMapViewOfSection_SystemCall_6_1_7600
	cmp dword ptr [rax+120h], 7601
	je  NtMapViewOfSection_SystemCall_6_1_7601
	jmp NtMapViewOfSection_SystemCall_Unknown
NtMapViewOfSection_Check_10_0_XXXX:              ; Check build number for Windows 10.
	cmp dword ptr [rax+120h], 10240
	je  NtMapViewOfSection_SystemCall_10_0_10240
	cmp dword ptr [rax+120h], 10586
	je  NtMapViewOfSection_SystemCall_10_0_10586
	cmp dword ptr [rax+120h], 14393
	je  NtMapViewOfSection_SystemCall_10_0_14393
	cmp dword ptr [rax+120h], 15063
	je  NtMapViewOfSection_SystemCall_10_0_15063
	cmp dword ptr [rax+120h], 16299
	je  NtMapViewOfSection_SystemCall_10_0_16299
	cmp dword ptr [rax+120h], 17134
	je  NtMapViewOfSection_SystemCall_10_0_17134
	cmp dword ptr [rax+120h], 17763
	je  NtMapViewOfSection_SystemCall_10_0_17763
	cmp dword ptr [rax+120h], 18362
	je  NtMapViewOfSection_SystemCall_10_0_18362
	cmp dword ptr [rax+120h], 18363
	je  NtMapViewOfSection_SystemCall_10_0_18363
	jmp NtMapViewOfSection_SystemCall_Unknown
NtMapViewOfSection_SystemCall_5_X_XXXX:          ; Windows XP and Server 2003
	mov eax, 0025h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_6_0_6000:          ; Windows Vista SP0
	mov eax, 0025h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_6_0_6001:          ; Windows Vista SP1 and Server 2008 SP0
	mov eax, 0025h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_6_0_6002:          ; Windows Vista SP2 and Server 2008 SP2
	mov eax, 0025h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_6_1_7600:          ; Windows 7 SP0
	mov eax, 0025h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_6_1_7601:          ; Windows 7 SP1 and Server 2008 R2 SP0
	mov eax, 0025h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_6_2_XXXX:          ; Windows 8 and Server 2012
	mov eax, 0026h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_6_3_XXXX:          ; Windows 8.1 and Server 2012 R2
	mov eax, 0027h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_10_0_10240:        ; Windows 10.0.10240 (1507)
	mov eax, 0028h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_10_0_10586:        ; Windows 10.0.10586 (1511)
	mov eax, 0028h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_10_0_14393:        ; Windows 10.0.14393 (1607)
	mov eax, 0028h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_10_0_15063:        ; Windows 10.0.15063 (1703)
	mov eax, 0028h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_10_0_16299:        ; Windows 10.0.16299 (1709)
	mov eax, 0028h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_10_0_17134:        ; Windows 10.0.17134 (1803)
	mov eax, 0028h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_10_0_17763:        ; Windows 10.0.17763 (1809)
	mov eax, 0028h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_10_0_18362:        ; Windows 10.0.18362 (1903)
	mov eax, 0028h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_10_0_18363:        ; Windows 10.0.18363 (1909)
	mov eax, 0028h
	jmp NtMapViewOfSection_Epilogue
NtMapViewOfSection_SystemCall_Unknown:           ; Unknown/unsupported version.
	ret
NtMapViewOfSection_Epilogue:
	mov r10, rcx
	syscall
	ret
NtMapViewOfSection ENDP

// ...
</code></pre>
<h4>Explanation</h4>
<p>The PEB structure contains three members that can be used to determine the Windows OS version:</p>
<ul>
<li>
<p><code>OSBuildNumber</code></p>
</li>
<li>
<p><code>OSMajorVersion</code></p>
</li>
<li>
<p><code>OSMinorVersion</code></p>
</li>
</ul>
<p>The 64-bit assembly functions generated by SysWhispers use these 
members to jump to the location where the correct SSN is located as a 
hardcoded value. The logic being utilized is essentially several if 
&amp; else if statements. For example, if the target machine is Windows 
10 1809 then the following logic occurs:</p>
<ol>
<li>
<p>Since the <em>major version</em> member of the PEB is equal to 10, the <code>NtMapViewOfSection_Check_10_0_XXXX</code> label is executed.</p>
</li>
<li>
<p>This label then checks the <em>build number</em> of the system. In this example, that number is 1809 which makes it jump to the <code>NtMapViewOfSection_SystemCall_10_0_17763</code> label.</p>
</li>
<li>
<p>The SSN is then set to <code>0028h</code></p>
</li>
<li>
<p>A final jump happens to the <code>NtMapViewOfSection_Epilogue</code> label where the remaining syscall instructions are executed. Recall that a syscall function has the following format:</p>
</li>
</ol>
<pre><code>mov r10, rcx
mov eax, SSN
syscall
ret
</code></pre>
<h3>SysWhispers2</h3>
<p><a href="https://github.com/jthuraisamy/SysWhispers2" target="_blank">SysWhispers2</a>
 shares the same concept as its previous version with the main 
difference being that SysWhispers2 does not require the user to specify 
which Windows versions to support in the Python generator. This is 
because SysWhispers2 no longer relies on the Windows X86-64 System Call 
Table for the SSNs and instead uses a method called <em>Sorting By System Call Address</em>.
 This method eliminates the need to have the assembly instructions 
manually choose the SSN at runtime, resulting in smaller syscalls stubs.</p>
<h3>Sorting By System Call Address</h3>
<p>Sorting by system call address is a method to retrieve the SSN of a 
syscall during runtime. This is done by finding all syscalls starting 
with <code>Zw</code> and then saving their address in an array and 
sorting them in ascending order (smallest to biggest addresses). The SSN
 will become the index of the system call stored in the array.</p>
<h4>SysWhispers2 Implementation</h4>
<p>Sorting by system call address is done via Syswhispers2's <a href="https://github.com/jthuraisamy/SysWhispers2/blob/main/example-output/Syscalls.c#L32" target="_blank">SW2_PopulateSyscallList</a> function which <a href="https://github.com/jthuraisamy/SysWhispers2/blob/main/example-output/Syscalls.c#L49" target="_blank">fetches NTDLL's base address</a> and its export directory. Using that information it <a href="https://github.com/jthuraisamy/SysWhispers2/blob/main/example-output/Syscalls.c#L77" target="_blank">calculates the RVAs</a> of the exported functions (addresses, names, ordinals). Recall the <em>IAT Hiding &amp; Obfuscation - Replacing GetProcAddress</em> module where this was performed.</p>
<p>Next, SysWhispers2 checks the exported function names for ones prefixed with <code>Zw</code>. Those function names are hashed and saved into an <a href="https://github.com/jthuraisamy/SysWhispers2/blob/main/example-output/Syscalls.c#L92" target="_blank">array</a> along with their addresses. After that, <code>SW2_PopulateSyscallList</code> sorts the addresses collected in <a href="https://github.com/jthuraisamy/SysWhispers2/blob/main/example-output/Syscalls.c#L104" target="_blank">ascending order</a>.</p>
<p>To find a syscall's SSN, the <a href="https://github.com/jthuraisamy/SysWhispers2/blob/main/example-output/Syscalls.c#L128" target="_blank">SW2_GetSyscallNumber</a> function takes the hash of the target syscall name and <a href="https://github.com/jthuraisamy/SysWhispers2/blob/main/example-output/Syscalls.c#L137" target="_blank">returns the index</a> where this syscall hash is found in the array. The index value is the SSN of the syscall.</p>
<p>A visual example of the implementation is shown below.</p>
<p><img src="Syscalls%20-%20SysWhispers_files/syswhipsers2-syscall-search.png" alt="image"></p>
<h4>SysWhispers2 Sample Output</h4>
<p>SysWhispers2 is used to generate a direct syscall for <code>NtMapViewOfSection</code>.</p>
<pre><code>.data
currentHash DWORD 0

.code
EXTERN SW2_GetSyscallNumber: PROC
    
WhisperMain PROC
    pop rax
    mov [rsp+ 8], rcx              ; Save registers.
    mov [rsp+16], rdx
    mov [rsp+24], r8
    mov [rsp+32], r9
    sub rsp, 28h
    mov ecx, currentHash
    call SW2_GetSyscallNumber
    add rsp, 28h
    mov rcx, [rsp+ 8]              ; Restore registers.
    mov rdx, [rsp+16]
    mov r8, [rsp+24]
    mov r9, [rsp+32]
    mov r10, rcx
    syscall                        ; Issue syscall
    ret
WhisperMain ENDP

NtMapViewOfSection PROC
    mov currentHash, 060C9AE95h    ; Load function hash into global variable.
    call WhisperMain               ; Resolve function hash into syscall number and make the call
NtMapViewOfSection ENDP

end
</code></pre>
<h4>Explanation</h4>
<p><code>060C9AE95h</code> is the hash value in hex for the <code>ZwMapViewOfSection</code> string. Calling <code>NtMapViewOfSection</code> will first load the hash value into the global variable <code>currentHash</code>, and call <code>WhisperMain</code>. <code>WhisperMain</code> is the function responsible for calling the previously explained <code>SW2_GetSyscallNumber</code> C function that will return the SSN using the syscall's hash value, which in this case is <code>currentHash</code>.</p>
<p>The <code>mov [rsp+XX], XXX</code> instructions are used to save the registers to the stack before calling <code>SW2_GetSyscallNumber</code>, and the <code>mov XXX, [rsp+ XX]</code> instructions are used to restore the registers to what they were before the <code>SW2_GetSyscallNumber</code> call. This is needed because calling <code>SW2_GetSyscallNumber</code> will change these registers' values. Finally, at the end of the <code>WhisperMain</code> function, the usual syscall instructions are there present:</p>
<pre><code>mov r10, rcx
syscall                      
ret
</code></pre>
<p>Notice how the <code>mov eax, SSN</code> instruction is missing. This is because when a function is called, its returned output is stored in the <code>eax</code> register. Since <code>SW2_GetSyscallNumber</code> was called before these instructions, this means that the SSN is already stored in the <code>eax</code> register.</p>
<h3>SysWhispers3</h3>
<p>Recall that <code>syscall</code> is responsible for shifting the execution flow from user mode to kernel mode. Legitimate <code>syscall</code> instructions should always be executed from within the <code>ntdll.dll</code> address space. Therefore, when the <code>syscall</code> instruction is included in the binary, as was the case with SysWhispers and SysWhispers2, the <code>syscall</code> instruction occurs from outside of that address space. Therefore, a binary performing a <code>syscall</code> instruction can be an indicator of malicious intent.</p>
<p>The updates in Syswhispers3 are found in the <a href="https://klezvirus.github.io/RedTeaming/AV_Evasion/NoSysWhisper/" target="_blank">SysWhispers is dead, long live SysWhispers!</a> blog post. The summary of changes is shown below.</p>
<h4>Changes To SysWhispers3</h4>
<p>Instead of calling the <code>syscall</code> instruction directly from within the assembly functions, SysWhispers3 will search for the <code>syscall</code> instruction in <code>ntdll.dll</code>'s address space, perform a jump instruction and execute the <code>syscall</code> instruction. This method is utilizing the indirect syscall technique which is discussed later.</p>
<p>Furthermore, Syswhispers3 comes with a <code>jumper_randomized</code> option that will perform a jump to the <code>syscall</code> instruction that belongs to a random function. For example, when calling <code>NtAllocateVirtualMemory</code> with this option, the <code>syscall</code> instruction that will be jumped to, doesn't belong to <code>NtAllocateVirtualMemory</code> in <code>ntdll.dll</code>. Instead, the instruction belongs to another syscall like the <code>NtTestAlert</code> function.</p>
<p>Similar to the previous version, Syswhispers3 uses the sorting by system call address method to find a syscall.</p>
<h4>SysWhispers3 Sample Output</h4>
<p>SysWhispers3 is used to generate a syscall calling stub for the <code>NtMapViewOfSection</code> function.  <code>Syswhispers3</code> output looks similar to <code>Syswhispers2</code> with the main difference being the additional <code>SW3_GetRandomSyscallAddress</code> and <code>SW3_GetSyscallNumber</code> function calls, which are shown and explained below.</p>
<p><img src="Syscalls%20-%20SysWhispers_files/syswhispers-314041015-7c969ae9-8b74-46a5-bf36-2c6bbedad332.png" alt="image"></p>
<p><strong>Syscalls-asm.x64.asm</strong></p>
<pre><code>.code

EXTERN SW3_GetSyscallNumber: PROC

EXTERN SW3_GetRandomSyscallAddress: PROC

NtMapViewOfSection PROC
	mov [rsp +8], rcx                      ; Save registers.
	mov [rsp+16], rdx
	mov [rsp+24], r8
	mov [rsp+32], r9
	sub rsp, 28h
	mov ecx, 01A80161Bh                     ; Load function hash into ECX.
	call SW3_GetRandomSyscallAddress        ; Get a syscall offset from a different api.
	mov r15, rax                            ; Save the address of the syscall {since SW3_GetRandomSyscallAddress will return the address of the 'syscall' instruction in rax register}
	mov ecx, 01A80161Bh                     ; Re-Load function hash into ECX (optional).
	call SW3_GetSyscallNumber               ; Resolve function hash into syscall number. {Now, eax has the SSN}
	add rsp, 28h				
	mov rcx, [rsp+8]                        ; Restore registers.
	mov rdx, [rsp+16]
	mov r8, [rsp+24]
	mov r9, [rsp+32]
	mov r10, rcx
	jmp r15                                 ; Jump to -&gt; Invoke system call. {r15 is the address of a random 'syscall' instruction in ntdll.dll}
NtMapViewOfSection ENDP

end
</code></pre>
<p><strong>SW3_GetSyscallNumber</strong> and <strong>SW3_GetRandomSyscallAddress</strong></p>
<p>The <code>SW3_GetSyscallNumber</code> function finds the syscall and <code>SW3_GetRandomSyscallAddress</code> fetches the address of the <code>syscall</code> instruction of a random syscall inside of <code>ntdll.dll</code> because the <code>jumper_randomized</code> option was used.</p>
<pre><code>EXTERN_C DWORD SW3_GetSyscallNumber(DWORD FunctionHash)
{
    // Ensure SW3_SyscallList is populated.
    if (!SW3_PopulateSyscallList()) return -1;

    for (DWORD i = 0; i &lt; SW3_SyscallList.Count; i++)
    {
        if (FunctionHash == SW3_SyscallList.Entries[i].Hash)
        {
            return i;
        }
    }

    return -1;
}


EXTERN_C PVOID SW3_GetRandomSyscallAddress(DWORD FunctionHash)
{
    // Ensure SW3_SyscallList is populated.
    if (!SW3_PopulateSyscallList()) return NULL;

    DWORD index = ((DWORD) rand()) % SW3_SyscallList.Count;

    while (FunctionHash == SW3_SyscallList.Entries[index].Hash){
        // Spoofing the syscall return address
        index = ((DWORD) rand()) % SW3_SyscallList.Count;
    }
    return SW3_SyscallList.Entries[index].SyscallAddress;
}

</code></pre>

            </div></div>
            <div id="accessory-container" class="hidden flex flex-col w-1/4 min-w-1/4 h-full">
                <div id="objectives" class="hidden p-4 border-r border-b bg-gray-900 border-gray-600 font-code w-full h-1/2">
                    <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg">Objectives</div>
                                                                        
                                                                        
            <div class="flex items-center mb-2 font-sans">
                                <input type="checkbox" id="objective-0" data-objective-id="0" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Download and interact with SysWhispers</label>
                            </div>
                                                                        
                                                                        
                    <div class="flex items-center mb-2 font-sans">
                                <input type="checkbox" id="objective-1" data-objective-id="1" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Review the 'Sorting By System Call Address' concept and how it's utilized in the latest version of SysWhispers</label>
                            </div>
                                                                        
                                                                        
                    <div class="flex items-center mb-2 font-sans">
                                <input type="checkbox" id="objective-2" data-objective-id="2" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Incorporate the usage of SysWhispers3 into an implementation</label>
                            </div>
                                                                        
                                                                        
                    <div class="flex items-center mb-2 font-sans">
                                <input type="checkbox" id="objective-3" data-objective-id="3" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Read the klezvirus.github.io/RedTeaming/AV_Evasion/NoSysWhisper/ paper</label>
                            </div>
                                                                                  
                </div>
                <div id="ide" class="hidden p-4 border-r border-b border-gray-600 font-code w-full h-1/2">
                    <textarea class="bg-gray-900 outline-0 w-full h-full resize-none font-sans" placeholder="Write temporary notes or code here"></textarea>
                </div>
            </div>  
        </div>
      </div>
      <div class="flex">
        <div class="flex flex-row flex-wrap justify-center items-center w-full bg-gray-700 border-r border-l border-gray-600 pl-4 pt-2 pb-2 rounded-bl rounded-br">
                        <div class="mr-2">
                <a data-target="_self" href="https://maldevacademy.com/modules/64"><button class="w-[100px] h-10 px-5 text-sm duration-150 text-white bg-blue-700 hover:bg-blue-800 rounded-lg focus:shadow-outline">Previous</button></a>           
            </div>
                        <div class="mr-2">
                <a data-target="_self" href="https://maldevacademy.com/modules"><button class="w-[100px] h-10 px-5 text-sm duration-150 text-white bg-blue-700 hover:bg-blue-800 rounded-lg focus:shadow-outline">Modules</button></a>           
            </div>
            <div class="my-2 mr-2">
            <form id="complete-module" action="https://maldevacademy.com/modules/65/complete" method="POST">
                <input type="hidden" name="_token" value="YwmJrjvrFLFoheCqdySsfQHrDWEGzxTLXO7qfost">                <button id="complete-btn" class="w-[100px] h-10 px-5 text-white text-sm duration-150 bg-green-700 rounded-lg focus:shadow-outline hover:bg-green-800 ">Complete</button>
            </form>
            <form id="uncomplete-module" action="https://maldevacademy.com/modules/65/progress" method="POST">
                <input type="hidden" name="_token" value="YwmJrjvrFLFoheCqdySsfQHrDWEGzxTLXO7qfost">                <button id="uncomplete-btn" class="w-[100px] h-10 px-5 text-white text-sm duration-150 bg-red-700 rounded-lg focus:shadow-outline hover:bg-red-800 hidden">Undo</button>
            </form>
            </div>
                                    <div class="mr-2">
                <a data-target="_self" href="https://maldevacademy.com/modules/66"><button class="w-[100px] h-10 px-5 text-sm duration-150 text-white bg-blue-700 hover:bg-blue-800 rounded-lg focus:shadow-outline">Next</button></a>           
            </div>
                    </div>
    </div>
</div>

<footer id="footer" class="text-gray-400 border-t-[1px] border-gray-700 bg-gray-900 body-font hidden">
    <div class="container px-5 py-8 mx-auto flex items-center sm:flex-row flex-col">
      <p class="text-sm text-gray-400 sm:ml-4 sm:pl-4 sm:border-gray-800 sm:py-2 sm:mt-0 mt-4">Â© 2023 MalDev Academy</p>
        <a href="https://twitter.com/maldevacademy" target="_blank" class="text-gray-500 hover:text-white ml-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg>
        </a>
      <span class="inline-flex sm:ml-auto sm:mt-0 mt-4 justify-center sm:justify-start">
        <a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">
          Terms and Conditions
      </a></span><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">
    </a></div><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">
  </a></footer><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">        

        <script src="Syscalls%20-%20SysWhispers_files/jquery-3.6.0.min.js"></script>
        <script src="Syscalls%20-%20SysWhispers_files/bootstrap.min.js"></script>
        <link rel="preload" as="style" href="Syscalls%20-%20SysWhispers_files/app.4474f4d1.css"><link rel="modulepreload" href="Syscalls%20-%20SysWhispers_files/app.5f3af5ce.js"><link rel="stylesheet" href="Syscalls%20-%20SysWhispers_files/app.4474f4d1.css"><script type="module" src="Syscalls%20-%20SysWhispers_files/app.5f3af5ce.js"></script><script src="Syscalls%20-%20SysWhispers_files/navbar.js"></script>
<script src="Syscalls%20-%20SysWhispers_files/moduleviewer.js"></script>

 
<script>
$(document).ready(function() {
    $('a:not([data-target="_self"])').attr('target', '_blank');

    $('input[type=checkbox]').change(function() {
    var checked = $(this).is(':checked');
    var userId = 260;
    var moduleId = 65;
    var objectiveId = $(this).data('objective-id');
    $.ajax({
        url: checked ? "https://maldevacademy.com/complete/objective" : "https://maldevacademy.com/remove/objective",
        type: "POST",
        data: {
        _token: "YwmJrjvrFLFoheCqdySsfQHrDWEGzxTLXO7qfost",
        user_id: userId,
        module_id: moduleId,
        objective_id: objectiveId
        },
        success: function(response) {

        },
        error: function(xhr) {
        console.log('Error');
        }
    });
    });

    $('#complete-module').submit(function(event) {
    event.preventDefault(); // Prevent default form submission

    var form = $(this);
    var url = form.attr('action');
    var data = form.serialize();
    var completeBtn = form.find('#complete-btn');
    var uncompleteBtn = $('#uncomplete-btn');

    $.ajax({
        type: 'POST',
        url: url,
        data: data,
        success: function(response) {
            completeBtn.addClass('hidden');
            uncompleteBtn.removeClass('hidden');
        },
        error: function(xhr) {
            console.log('Error');
        }
    });
});

$('#uncomplete-module').submit(function(event) {
    event.preventDefault(); // Prevent default form submission

    var form = $(this);
    var url = form.attr('action');
    var data = form.serialize();
    var completeBtn = $('#complete-btn');
    var uncompleteBtn = form.find('#uncomplete-btn');

    $.ajax({
        type: 'POST',
        url: url,
        data: data,
        success: function(response) {
            uncompleteBtn.addClass('hidden');
            completeBtn.removeClass('hidden');
        },
        error: function(xhr) {
            console.log('Error');
        }
    });
});
});
</script>
    
</a></body></html>
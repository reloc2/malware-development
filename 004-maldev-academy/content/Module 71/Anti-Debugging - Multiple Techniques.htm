<!DOCTYPE html>
<html class="dark"><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie-edge">
        <meta name="csrf-token" content="YwmJrjvrFLFoheCqdySsfQHrDWEGzxTLXO7qfost">
        <link rel="stylesheet" href="Anti-Debugging%20-%20Multiple%20Techniques_files/template.css">
        <link rel="shortcut icon" href="https://maldevacademy.com/favicon.ico">
        <!-- fontawesome for icons -->
        <link rel="stylesheet" href="Anti-Debugging%20-%20Multiple%20Techniques_files/font-awesome.min.css">
        <!-- google fonts -->
        <link rel="preconnect" href="https://fonts.gstatic.com/">
        <link href="Anti-Debugging%20-%20Multiple%20Techniques_files/css2.css" rel="stylesheet">
        <link href="Anti-Debugging%20-%20Multiple%20Techniques_files/css2_002.css" rel="stylesheet">
        <title>Anti-Debugging - Multiple Techniques</title>
        <!-- Custom css files, order matters -->
        <link rel="preload" as="style" href="Anti-Debugging%20-%20Multiple%20Techniques_files/app.fdbb573b.css"><link rel="stylesheet" href="Anti-Debugging%20-%20Multiple%20Techniques_files/app.fdbb573b.css"><link rel="stylesheet" href="Anti-Debugging%20-%20Multiple%20Techniques_files/viewer.css">
    </head>
    <body>
        <nav id="navbar" class="px-2 sm:px-4 py-2.5 bg-gray-900 sticky hidden">
    <div class="container flex flex-wrap justify-between mx-auto">
      <a data-target="_self" href="https://maldevacademy.com/" class="flex items-center">
        <div class="main-logo flex flex-row items-center">
            <span class="text-xl logo-font text-white">MALDEV</span>
            <img class="w-[25px] mx-2 relative bottom-1" src="Anti-Debugging%20-%20Multiple%20Techniques_files/logo-bug-2.png" alt="Logo">   
            <span class="text-xl logo-font text-white">ACADEMY</span>          
        </div>
      </a>
      <button data-collapse-toggle="navbar-default" id="navbar-phone-btn" type="button" class="inline-flex items-center p-2 ml-3 text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-default" aria-expanded="false">
        <span class="sr-only">Open main menu</span>
        <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
      </button>
      <div class="hidden w-full md:block md:w-auto" id="navbar-default">
        <ul class="flex flex-col items-center p-4 mt-4 bg-gray-50 rounded-lg border border-gray-100 md:flex-row md:space-x-8 md:mt-0 md:text-sm md:font-medium md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
          <li>
            <a data-target="_self" href="https://maldevacademy.com/" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Home</a>
          </li>
          <li>
            <a data-target="_self" href="https://maldevacademy.com/faq" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">FAQ</a>
          </li>
          <li>
            <a data-target="_self" href="https://maldevacademy.com/syllabus" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Syllabus</a>
          </li>
                              <li>
            <a data-target="_self" href="https://maldevacademy.com/pricing" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Pricing</a>
          </li>
                                        <li>
            <a data-target="_self" href="https://maldevacademy.com/profile" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Profile</a>
          </li>
          <li>
            <form action="https://maldevacademy.com/logout" method="POST">
            <input type="hidden" name="_token" value="YwmJrjvrFLFoheCqdySsfQHrDWEGzxTLXO7qfost">              <button type="submit" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Logout</button>
            </form>
          </li>
          <li class="mt-4 md:mt-0">
            <a data-target="_self" href="https://maldevacademy.com/modules" class="text-white bg-blue-700 hover:bg-blue-800 font-medium rounded-lg text-sm px-5 py-2.5 text-center md:mr-3 mr-0 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Modules</a>
          </li>
                  </ul>
      </div>
    </div>
  </nav>        <div class="bg-gray-900 p-4">
    <div class="flex">
        <div class="md:flex-row flex-col flex md:items-center w-1/2 bg-gray-700 border-l border-t border-gray-600 pl-4 pt-2 pb-2 rounded-tl">
            <div>
                Module 71 - Anti-Debugging - Multiple Techniques
            </div>
            <div class="ml-2 w-4 h-4 bg-orange-600 rounded-full"></div>
        </div>
        <div class="flex justify-end items-center w-1/2 bg-gray-700 pr-4 pt-2 pb-2 rounded-tr border-t border-r border-gray-600">
            <div class="enlarge-container pr-4">
                <img src="Anti-Debugging%20-%20Multiple%20Techniques_files/enlarge.svg" onclick="toggleScreenWidth()" class="hover:bg-gray-600 rounded-sm cursor-pointer" id="enlargeToggle" alt="Screen Width" width="20px">
            </div>
            <div class="objectives-container pr-4">
                <img src="Anti-Debugging%20-%20Multiple%20Techniques_files/objectives.svg" onclick="toggleObjectives()" class="hover:bg-gray-600 cursor-pointer" id="objectivesToggle" alt="Objectives" width="20px">
            </div>
            <div class="terminal-container  pr-4 ">
                <img src="Anti-Debugging%20-%20Multiple%20Techniques_files/ide.svg" onclick="toggleIde()" class="hover:bg-gray-600 rounded-sm cursor-pointer" id="terminalToggle" alt="Terminal" width="22px">
            </div>
                                    <div class="dl-container">
                <a href="https://maldevacademy.com/download/file/AntiDebugTechs" target="_blank">
                    <img src="Anti-Debugging%20-%20Multiple%20Techniques_files/dl.svg" class="hover:bg-gray-600 rounded-full cursor-pointer" alt="Download" width="20px">
                </a>
            </div>
                                </div>
    </div>
    <div id="height-container" class="flex h-full min-h-[800px]">
        <div class="flex max-w-full min-w-full">
            <div id="description-container" class="viewer code-description h-full bg-gray-800 p-4 border-r border-l border-b border-gray-600 px-5 md:px-10 lg:px-20 w-full"><div class="toastui-editor-contents" style="overflow-wrap: break-word;">
            <h2>Anti-Debugging - Multiple Techniques</h2>
<h3>Introduction</h3>
<p>Security researchers and malware analysts will use debugging to 
enhance their understanding of malware samples. This enables them to 
write better detection rules against these samples. As a malware 
developer, one should always arm themselves with anti-debugging 
techniques to make the process more time-consuming for analysts.</p>
<p>This module discusses several anti-debugging techniques.</p>
<h3>Detecting Debuggers Via IsDebuggerPresent</h3>
<p>One of the easiest anti-debugging techniques is to use the <a href="https://learn.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-isdebuggerpresent" target="_blank">IsDebuggerPresent</a> WinAPI. This function returns <code>TRUE</code> if a debugger is attached to the calling process or <code>FALSE</code> if there isn't. The following code snippet shows the function to detect a debugger.</p>
<pre><code>if (IsDebuggerPresent()) {
  printf("[i] IsDebuggerPresent detected a debugger \n");
  // Run harmless code..
}
</code></pre>
<h3>IsDebuggerPresent Replacement (1)</h3>
<p>Calling the <code>IsDebuggerPresent</code> WinAPI is suspicious even 
if it is well hidden through API hashing. The WinAPI is considered a 
very basic approach to detect debuggers and can be bypassed with tools 
like <a href="https://github.com/x64dbg/ScyllaHide" target="_blank">ScyllaHide</a> which is an anti anti-debugger plugin for xdbg.</p>
<p>A better approach is to create a custom version of the <code>IsDebuggerPresent</code> WinAPI. Recall the <em>Windows Processes - beginner module</em> which showed the PEB structure having a <code>BeingDebugged</code> member that is set to 1 when the process is being debugged. A simple <code>IsDebuggerPresent</code> WinAPI replacement involves checking the <code>BeingDebugged</code> value as shown in the custom function below.</p>
<p>The <code>IsDebuggerPresent2</code> function returns <code>TRUE</code> if the <code>BeingDebugged</code> element is set to 1.</p>
<pre><code>BOOL IsDebuggerPresent2() {

  // getting the PEB structure
#ifdef _WIN64
	PPEB					pPeb = (PEB*)(__readgsqword(0x60));
#elif _WIN32
	PPEB					pPeb = (PEB*)(__readfsdword(0x30));
#endif

  // checking the 'BeingDebugged' element
  if (pPeb-&gt;BeingDebugged == 1) 
    return TRUE;
	
   return FALSE;
}

</code></pre>
<h3>IsDebuggerPresent Replacement (2)</h3>
<p>Another way to make a custom-made version of the <code>IsDebuggerPresent</code> WinAPI is by utilizing the undocumented <a href="https://www.aldeid.com/wiki/PEB-Process-Environment-Block/NtGlobalFlag" target="_blank">NtGlobalFlag</a> flag which is also found within the PEB structure. The <code>NtGlobalFlag</code> member is set to <code>0x70</code> (hex) if the process is being debugged otherwise it's 0. It's important to note that the <code>NtGlobalFlag</code> element is set to <code>0x70</code>
 only when the process is created by the debugger. Therefore, this 
method will fail in detecting a debugger if it was attacher after 
execution.</p>
<p>The value <code>0x70</code> is derived from the combination of the following flags:</p>
<ul>
<li>
<p><code>FLG_HEAP_ENABLE_TAIL_CHECK</code> - <code>0x10</code></p>
</li>
<li>
<p><code>FLG_HEAP_ENABLE_FREE_CHECK</code> - <code>0x20</code></p>
</li>
<li>
<p><code>FLG_HEAP_VALIDATE_PARAMETERS</code> - <code>0x40</code></p>
</li>
</ul>
<p>The <code>IsDebuggerPresent3</code> function returns <code>TRUE</code> if the <code>NtGlobalFlag</code> element is set to <code>0x70</code>.</p>
<pre><code>
#define FLG_HEAP_ENABLE_TAIL_CHECK   0x10
#define FLG_HEAP_ENABLE_FREE_CHECK   0x20
#define FLG_HEAP_VALIDATE_PARAMETERS 0x40

BOOL IsDebuggerPresent3() {

  // getting the PEB structure
#ifdef _WIN64
	PPEB					pPeb = (PEB*)(__readgsqword(0x60));
#elif _WIN32
	PPEB					pPeb = (PEB*)(__readfsdword(0x30));
#endif

  // checking the 'NtGlobalFlag' element
  if (pPeb-&gt;NtGlobalFlag == (FLG_HEAP_ENABLE_TAIL_CHECK | FLG_HEAP_ENABLE_FREE_CHECK | FLG_HEAP_VALIDATE_PARAMETERS))
    return TRUE;
  
  return FALSE;
}
</code></pre>
<h3>Detecting Debugger Via NtQueryInformationProcess</h3>
<p>The <code>NtQueryInformationProcess</code> syscall will be utilized to detect debuggers via two flags, <code>ProcessDebugPort</code> and <code>ProcessDebugObjectHandle</code>.</p>
<p>Recall that <code>NtQueryInformationProcess</code> looks like the following</p>
<pre><code>NTSTATUS NtQueryInformationProcess(
  IN    HANDLE           ProcessHandle,               // Process handle for which information is to be retrieved.
  IN    PROCESSINFOCLASS ProcessInformationClass,     // Type of process information to be retrieved
  OUT   PVOID            ProcessInformation,          // Pointer to the buffer into which the function writes the requested information
  IN    ULONG            ProcessInformationLength,    // The size of the buffer pointed to by the 'ProcessInformation' parameter 
  OUT   PULONG           ReturnLength                 // Pointer to a variable in which the function returns the size of the requested information
);
</code></pre>
<h4>ProcessDebugPort Flag</h4>
<p>Microsoft's documentation on the <code>ProcessDebugPort</code> flag states the following:</p>
<p><em>Retrieves a DWORD_PTR value that is the port number of the 
debugger for the process. A nonzero value indicates that the process is 
being run under the control of a ring 3 debugger</em></p>
<p>In other words, if <code>NtQueryInformationProcess</code> returns a non-zero value received by the <code>ProcessInformation</code> parameter, the process is being actively debugged.</p>
<h4>ProcessDebugObjectHandle Flag</h4>
<p>The undocumented flag, <code>ProcessDebugObjectHandle</code>, works like the former <code>ProcessDebugPort</code>
 flag and is used to get a handle to the debug object handle of the 
current process which is created if the process is being debugged. A 
non-zero value obtained by the <code>ProcessInformation</code> parameter through <code>NtQueryInformationProcess</code> implies active debugging of the process.</p>
<p>In the case where <code>NtQueryInformationProcess</code> fails to retrieve the debug object handle, it means it did not detect a debugger and will return the error code <code>0xC0000353</code>. Based on Microsoft's documentation on <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-erref/596a1078-e883-4972-9bbc-49e60bebca55" target="_blank">NTSTATUS Values</a>, the error code is equivalent to <code>STATUS_PORT_NOT_SET</code>.</p>
<h4>NtQueryInformationProcess Anti-Debugging Code</h4>
<p>The <code>NtQIPDebuggerCheck</code> function uses both <code>ProcessInformation</code> &amp; <code>ProcessDebugObjectHandle</code> to detect debuggers. The function returns <code>TRUE</code> if <code>NtQueryInformationProcess</code> returns a valid handle using both <code>ProcessDebugPort</code> and <code>ProcessDebugObjectHandle</code> flags.</p>
<pre><code>BOOL NtQIPDebuggerCheck() {

	NTSTATUS                      STATUS                        = NULL;
	fnNtQueryInformationProcess   pNtQueryInformationProcess    = NULL;
	DWORD64                       dwIsDebuggerPresent           = NULL;
	DWORD64                       hProcessDebugObject           = NULL;

	// Getting NtQueryInformationProcess address
	pNtQueryInformationProcess = (fnNtQueryInformationProcess)GetProcAddress(GetModuleHandle(TEXT("NTDLL.DLL")), "NtQueryInformationProcess");
	if (pNtQueryInformationProcess == NULL) {
		printf("\t[!] GetProcAddress Failed With Error : %d \n", GetLastError());
		return FALSE;
	}

	// Calling NtQueryInformationProcess with the 'ProcessDebugPort' flag
	STATUS = pNtQueryInformationProcess(
		GetCurrentProcess(),
		ProcessDebugPort,
		&amp;dwIsDebuggerPresent,
		sizeof(DWORD64),
		NULL
	);

	if (STATUS != 0x0) {
		printf("\t[!] NtQueryInformationProcess [1] Failed With Status : 0x%0.8X \n", STATUS);
		return FALSE;
	}

	// If NtQueryInformationProcess returned a non-zero value, the handle is valid, which means we are being debugged
	if (dwIsDebuggerPresent != NULL) {
        // detected a debugger
		return TRUE;
	}

	// Calling NtQueryInformationProcess with the 'ProcessDebugObjectHandle' flag
	STATUS = pNtQueryInformationProcess(
		GetCurrentProcess(),
		ProcessDebugObjectHandle,
		&amp;hProcessDebugObject,
		sizeof(DWORD64),
		NULL
	);

	// If STATUS is not 0 and not 0xC0000353 (that is 'STATUS_PORT_NOT_SET')
	if (STATUS != 0x0 &amp;&amp; STATUS != 0xC0000353) {
		printf("\t[!] NtQueryInformationProcess [2] Failed With Status : 0x%0.8X \n", STATUS);
		return FALSE;
	}

	// If NtQueryInformationProcess returned a non-zero value, the handle is valid, which means we are being debugged
	if (hProcessDebugObject != NULL) {
        // detected a debugger
		return TRUE;
	}

	return FALSE;
}
</code></pre>
<h3>Detecting Debugger Via Hardware Breakpoints</h3>
<p>This method is only valid if hardware breakpoints are set during 
debugging. Hardware breakpoints, also known as hardware debug registers,
 are a feature of modern microprocessors that pauses the process's 
execution when a specific memory address or event is triggered. Hardware
 breakpoints are implemented in the processor itself and are therefore 
faster and more efficient than the normal software breakpoints, which 
rely on the operating system or debugger to periodically check the 
program's execution.</p>
<p>When hardware breakpoints are set, specific registers change in 
value. The values of these registers can be used to determine if a 
debugger is attached to the process. If the registers <code>Dr0</code>, <code>Dr1</code>, <code>Dr2</code> and <code>Dr3</code> contain a non-zero value, then the hardware breakpoint is set. The following example places a hardware breakpoint on the <code>NtAllocateVirtualMemory</code> syscall using the xdbg debugger. Notice how the value of <code>Dr0</code> is changed from zero to <code>NtAllocateVirtualMemory</code>'s address.</p>
<p><img src="Anti-Debugging%20-%20Multiple%20Techniques_files/anti-debugging-115282576-1557ca5f-2841-4a0f-ad73-63c30e03c84.png" alt="image"></p>
<p><img src="Anti-Debugging%20-%20Multiple%20Techniques_files/anti-debugging-215283166-37faff36-628c-43e4-aaf1-e41ad6310dd.png" alt="image"></p>
<p><img src="Anti-Debugging%20-%20Multiple%20Techniques_files/anti-debugging-315282633-6d0bf541-7327-42b9-af79-0b9f9489cd6.png" alt="image"></p>
<h4>Retrieving The Value Of The Registers</h4>
<p>To retrieve the value of the <code>Dr</code> registers, the <code>GetThreadContext</code> WinAPI can be used. Recall the usage of <code>GetThreadContext</code> from the <em>Thread Hijacking</em> modules in which it was used to retrieve the context of a specified thread. The context was returned as a <code>CONTEXT</code> structure. This structure also includes the values of the <code>Dr0</code>, <code>Dr1</code>, <code>Dr2</code> and <code>Dr3</code> registers.</p>
<p>The <code>HardwareBpCheck</code> function detects the presence of a debugger by checking the values of the aforementioned registers. The function returns <code>TRUE</code>if a debugger is detected.</p>
<pre><code>BOOL HardwareBpCheck() {

	CONTEXT		Ctx		= { .ContextFlags = CONTEXT_DEBUG_REGISTERS };

	if (!GetThreadContext(GetCurrentThread(), &amp;Ctx)) {
		printf("\t[!] GetThreadContext Failed With Error : %d \n", GetLastError());
		return FALSE;
	}

	if (Ctx.Dr0 != NULL || Ctx.Dr1 != NULL || Ctx.Dr2 != NULL || Ctx.Dr3 != NULL)
		return TRUE; // Detected a debugger

	return FALSE;
}
</code></pre>
<h3>Detecting Debuggers Via BlackListed Arrays</h3>
<p>Another way to detect debugging processes can be done by checking the
 names of currently running processes against a list of known debugger 
names. This "blacklist" of names is stored in a hardcoded array. If a 
match is found between the name of a process and the blacklist, then a 
debugger application is running on the system.</p>
<p>Enumerating the processes running on the machine can be from any of the previously discussed techniques. For this scenario, the <code>CreateToolhelp32Snapshot</code> process enumeration technique will be used.</p>
<p>The blacklist array used is represented as the following</p>
<pre><code>#define BLACKLISTARRAY_SIZE 5 // Number of elements inside the array

WCHAR* g_BlackListedDebuggers[BLACKLISTARRAY_SIZE] = {
		L"x64dbg.exe",                 // xdbg debugger	
		L"ida.exe",                    // IDA disassembler
		L"ida64.exe",                  // IDA disassembler
		L"VsDebugConsole.exe",         // Visual Studio debugger	
		L"msvsmon.exe"                 // Visual Studio debugger
};
</code></pre>
<p>The blacklist array should contain as many debugger names as possible
 in order to detect a wider range of debuggers. Additionally, the 
strings should be obfuscated via string hashing as debugger names in the
 binary could be used as IoCs.</p>
<p>The <code>BlackListedProcessesCheck</code> function uses the <code>g_BlackListedDebuggers</code> array as the blacklist processes array. It will return <code>TRUE</code> in case a process name matches with an element of <code>g_BlackListedDebuggers</code></p>
<pre><code>BOOL BlackListedProcessesCheck() {

	HANDLE				hSnapShot		= NULL;
	PROCESSENTRY32W		ProcEntry		= { .dwSize = sizeof(PROCESSENTRY32W) };
	BOOL				bSTATE			= FALSE;


	hSnapShot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, NULL);
	if (hSnapShot == INVALID_HANDLE_VALUE) {
		printf("\t[!] CreateToolhelp32Snapshot Failed With Error : %d \n", GetLastError());
		goto _EndOfFunction;
	}

	if (!Process32FirstW(hSnapShot, &amp;ProcEntry)) {
		printf("\t[!] Process32FirstW Failed With Error : %d \n", GetLastError());
		goto _EndOfFunction;
	}

	do {
		// Loops through the 'g_BlackListedDebuggers' array and comparing each element to the 
		// Current process name captured from the snapshot 
		for (int i = 0; i &lt; BLACKLISTARRAY_SIZE; i++){
			if (wcscmp(ProcEntry.szExeFile, g_BlackListedDebuggers[i]) == 0) { 
				// Debugger detected	
				wprintf(L"\t[i] Found \"%s\" Of Pid : %d \n", ProcEntry.szExeFile, ProcEntry.th32ProcessID);
				bSTATE = TRUE;
				break;
			}
		}
	
	} while (Process32Next(hSnapShot, &amp;ProcEntry));


_EndOfFunction:
	if (hSnapShot != NULL)
		CloseHandle(hSnapShot);
	return bSTATE;
}
</code></pre>
<h3>Breakpoint Detection Via GetTickCount64</h3>
<p>Breakpoints are used to pause the execution of a program at a 
specific point, allowing one to inspect the memory, registers state, 
variables and more.</p>
<p>The pause of execution can be detected by using the <a href="https://learn.microsoft.com/en-us/windows/win32/api/sysinfoapi/nf-sysinfoapi-gettickcount64" target="_blank">GetTickCount64</a>
 WinAPI. This function retrieves the number of milliseconds that have 
elapsed since the system was started. Analyzing the time taken by the 
processor between two <code>GetTickCount64</code> can indicate whether 
the malware is being debugged. If the time took longer than expected, 
it's safe to assume the malware is being debugged.</p>
<p><img src="Anti-Debugging%20-%20Multiple%20Techniques_files/anti-debugging-415305654-6593a2cd-5fc1-4f8c-b4dc-9f4eb55c47b.png" alt="image"></p>
<h4>Detecting Delays</h4>
<p>Breakpoints can be detected by calculating the average of T1 - T0 and
 storing it as a hardcoded value. When the output of T1 - T0 exceeds 
this value, the delay is likely caused by breakpoints. For example, if 
the output of T1 - T0 on the host machine is 20 seconds, but the output 
is greater than that during runtime, then there is a strong possibility 
that the delay between these two points is caused by a breakpoint. The 
original value should be increased slightly to account for processors 
that may be slower.</p>
<h4>GetTickCount64 Anti-Debugging Code</h4>
<p>The <code>TimeTickCheck1</code> function uses the described approach to detect breakpoints. The function returns <code>TRUE</code> if <code>dwTime2 - dwTime1</code> exceeds the average value of executing code in between, which is 50.</p>
<pre><code>BOOL TimeTickCheck1() {

	DWORD	dwTime1		= NULL,
		    dwTime2		= NULL;

	dwTime1 = GetTickCount64();

/*
		OTHER CODE			
*/
	
	dwTime2 = GetTickCount64();
	
	printf("\t[i] (dwTime2 - dwTime1) : %d \n", (dwTime2 - dwTime1));

	if ((dwTime2 - dwTime1) &gt; 50) {
		return TRUE;
	}

	return FALSE;
}
</code></pre>
<h3>Breakpoint Detection Via QueryPerformanceCounter</h3>
<p>The <a href="https://learn.microsoft.com/en-us/windows/win32/api/profileapi/nf-profileapi-queryperformancecounter" target="_blank">QueryPerformanceCounter</a> WinAPI is the same as the previously shown <code>GetTickCount64</code> WinAPI. The difference is that <code>QueryPerformanceCounter</code>
 uses a high-resolution performance counter provided by the hardware 
which can measure time in increments of nanoseconds whereas <code>GetTickCount64</code> uses a time counter that increments every millisecond. Note that <code>QueryPerformanceCounter</code> retrieves the performance-counter value in counts rather than milliseconds.</p>
<p>The <code>TimeTickCheck2</code> function uses the <code>QueryPerformanceCounter</code> WinAPI to detect breakpoints. It returns TRUE if <code>Time2.QuadPart - Time1.QuadPart</code> exceeds the average value of executing code in between, which is 100000 counts.</p>
<pre><code>BOOL TimeTickCheck2() {

	LARGE_INTEGER	Time1	= { 0 },
			        Time2	= { 0 };

	if (!QueryPerformanceCounter(&amp;Time1)) {
		printf("\t[!] QueryPerformanceCounter [1] Failed With Error : %d \n", GetLastError());
		return FALSE;
	}

/*
		OTHER CODE			
*/

	if (!QueryPerformanceCounter(&amp;Time2)) {
		printf("\t[!] QueryPerformanceCounter [2] Failed With Error : %d \n", GetLastError());
		return FALSE;
	}

	printf("\t[i] (Time2.QuadPart - Time1.QuadPart) : %d \n", (Time2.QuadPart - Time1.QuadPart));
	
	if ((Time2.QuadPart - Time1.QuadPart) &gt; 100000){
		return TRUE;
	}

	return FALSE;
}
</code></pre>
<h3>Detecting Debugger Via DebugBreak</h3>
<p><a href="https://learn.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-debugbreak" target="_blank">DebugBreak</a> causes the breakpoint exception, <code>EXCEPTION_BREAKPOINT</code>,
 to occur in the current process. This exception is supposed to be 
handled by a debugger if it is attached to the current process. The 
technique is to trigger the exception and see if a debugger attempts to 
handle this exception.</p>
<p>A  <code>__try</code> and <code>__except</code> code block will be used to handle the exception from the <code>DebugBreak</code> call, and a <a href="https://learn.microsoft.com/en-us/windows/win32/debug/getexceptioncode" target="_blank">GetExceptionCode</a> call will be used to fetch the exception code generated in which case there are two possible scenarios:</p>
<ol>
<li>
<p>If the exception fetched is <code>EXCEPTION_BREAKPOINT</code> then <code>EXCEPTION_EXECUTE_HANDLER</code> is executed, this means the exception was not handled by a debugger.</p>
</li>
<li>
<p>If the exception is not <code>EXCEPTION_BREAKPOINT</code>, meaning a debugger handled the raised exception (and not our try-except code block), then <code>EXCEPTION_CONTINUE_SEARCH</code> is executed, this force the debugger to be responsible for handling the raised exception.</p>
</li>
</ol>
<p>The following <code>DebugBreakCheck</code> function returns <code>FALSE</code> if the <code>DebugBreak</code>
 WinAPI is successfully executed and the exception is not caught/handled
 by a debugger, and instead handled by our try-except code block, 
indicating that no debugger is attached to the current process.</p>
<pre><code>BOOL DebugBreakCheck() {

	__try {
		DebugBreak();
	}
	__except (GetExceptionCode() == EXCEPTION_BREAKPOINT ? EXCEPTION_EXECUTE_HANDLER : EXCEPTION_CONTINUE_SEARCH) {
		// if the exception is equal to EXCEPTION_BREAKPOINT, EXCEPTION_EXECUTE_HANDLER is executed and the function return FALSE
		return FALSE;
	}
	
	// if the exception is not equal to EXCEPTION_BREAKPOINT, EXCEPTION_CONTINUE_SEARCH is executed and the function return TRUE
	return TRUE;
}
</code></pre>
<h3>Detecting Debugger Via OutputDebugString</h3>
<p>Another WinAPI that can be utilized in detecting debuggers is <a href="https://learn.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-outputdebugstringw" target="_blank">OutputDebugString</a>. This function is used to send a string to the debugger to display. If a debugger exists, then <code>OutputDebugString</code> will succeed in performing its task.</p>
<p>One can run <code>OutputDebugString</code> and check if it failed using <code>GetLastError</code>, if it did, then <code>GetLastError</code> will return a non-zero error code. A non-zero error code in this case is equivalent to no debugger being present. If <code>GetLastError</code> returns zero then <code>OutputDebugString</code> succeeded in sending a string to a debugger.</p>
<p>The <code>OutputDebugStringCheck</code> function uses the above logic and returns <code>TRUE</code> if <code>OutputDebugStringW</code> succeeds. Additionally, it uses <a href="https://learn.microsoft.com/en-us/windows/win32/api/errhandlingapi/nf-errhandlingapi-setlasterror" target="_blank">SetLastError</a> to set the last error value to 1. This is simply to make sure that it is a non-zero value before the <code>OutputDebugString</code> call in order to reduce false positives.</p>
<pre><code>BOOL OutputDebugStringCheck() {

	SetLastError(1);
	OutputDebugStringW(L"MalDev Academy");
	
	// if GetLastError is 0, then OutputDebugStringW succeeded
	if (GetLastError() == 0) {
		return TRUE;
	}

	return FALSE;
}
</code></pre>

            </div></div>
            <div id="accessory-container" class="hidden flex flex-col w-1/4 min-w-1/4 h-full">
                <div id="objectives" class="hidden p-4 border-r border-b bg-gray-900 border-gray-600 font-code w-full h-1/2">
                    <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg">Objectives</div>
                                                                        
                                                                        
            <div class="flex items-center mb-2 font-sans">
                                <input type="checkbox" id="objective-0" data-objective-id="0" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Test out the various anti-debugging techniques shown in the module</label>
                            </div>
                                                                        
                                                                        
                    <div class="flex items-center mb-2 font-sans">
                                <input type="checkbox" id="objective-1" data-objective-id="1" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Find other functions that can be used for anti-debugging purposes</label>
                            </div>
                                                                        
                                                                        
                    <div class="flex items-center mb-2 font-sans">
                                <input type="checkbox" id="objective-2" data-objective-id="2" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                                <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Implement another anti-debugging technique that isn't mentioned in this module</label>
                            </div>
                                                                                  
                </div>
                <div id="ide" class="hidden p-4 border-r border-b border-gray-600 font-code w-full h-1/2">
                    <textarea class="bg-gray-900 outline-0 w-full h-full resize-none font-sans" placeholder="Write temporary notes or code here"></textarea>
                </div>
            </div>  
        </div>
      </div>
      <div class="flex">
        <div class="flex flex-row flex-wrap justify-center items-center w-full bg-gray-700 border-r border-l border-gray-600 pl-4 pt-2 pb-2 rounded-bl rounded-br">
                        <div class="mr-2">
                <a data-target="_self" href="https://maldevacademy.com/modules/70"><button class="w-[100px] h-10 px-5 text-sm duration-150 text-white bg-blue-700 hover:bg-blue-800 rounded-lg focus:shadow-outline">Previous</button></a>           
            </div>
                        <div class="mr-2">
                <a data-target="_self" href="https://maldevacademy.com/modules"><button class="w-[100px] h-10 px-5 text-sm duration-150 text-white bg-blue-700 hover:bg-blue-800 rounded-lg focus:shadow-outline">Modules</button></a>           
            </div>
            <div class="my-2 mr-2">
            <form id="complete-module" action="https://maldevacademy.com/modules/71/complete" method="POST">
                <input type="hidden" name="_token" value="YwmJrjvrFLFoheCqdySsfQHrDWEGzxTLXO7qfost">                <button id="complete-btn" class="w-[100px] h-10 px-5 text-white text-sm duration-150 bg-green-700 rounded-lg focus:shadow-outline hover:bg-green-800 ">Complete</button>
            </form>
            <form id="uncomplete-module" action="https://maldevacademy.com/modules/71/progress" method="POST">
                <input type="hidden" name="_token" value="YwmJrjvrFLFoheCqdySsfQHrDWEGzxTLXO7qfost">                <button id="uncomplete-btn" class="w-[100px] h-10 px-5 text-white text-sm duration-150 bg-red-700 rounded-lg focus:shadow-outline hover:bg-red-800 hidden">Undo</button>
            </form>
            </div>
                                    <div class="mr-2">
                <a data-target="_self" href="https://maldevacademy.com/modules/72"><button class="w-[100px] h-10 px-5 text-sm duration-150 text-white bg-blue-700 hover:bg-blue-800 rounded-lg focus:shadow-outline">Next</button></a>           
            </div>
                    </div>
    </div>
</div>

<footer id="footer" class="text-gray-400 border-t-[1px] border-gray-700 bg-gray-900 body-font hidden">
    <div class="container px-5 py-8 mx-auto flex items-center sm:flex-row flex-col">
      <p class="text-sm text-gray-400 sm:ml-4 sm:pl-4 sm:border-gray-800 sm:py-2 sm:mt-0 mt-4">© 2023 MalDev Academy</p>
        <a href="https://twitter.com/maldevacademy" target="_blank" class="text-gray-500 hover:text-white ml-2">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" aria-hidden="true"><path d="M8.29 20.251c7.547 0 11.675-6.253 11.675-11.675 0-.178 0-.355-.012-.53A8.348 8.348 0 0022 5.92a8.19 8.19 0 01-2.357.646 4.118 4.118 0 001.804-2.27 8.224 8.224 0 01-2.605.996 4.107 4.107 0 00-6.993 3.743 11.65 11.65 0 01-8.457-4.287 4.106 4.106 0 001.27 5.477A4.072 4.072 0 012.8 9.713v.052a4.105 4.105 0 003.292 4.022 4.095 4.095 0 01-1.853.07 4.108 4.108 0 003.834 2.85A8.233 8.233 0 012 18.407a11.616 11.616 0 006.29 1.84"></path></svg>
        </a>
      <span class="inline-flex sm:ml-auto sm:mt-0 mt-4 justify-center sm:justify-start">
        <a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">
          Terms and Conditions
      </a></span><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">
    </a></div><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">
  </a></footer><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">        

        <script src="Anti-Debugging%20-%20Multiple%20Techniques_files/jquery-3.6.0.min.js"></script>
        <script src="Anti-Debugging%20-%20Multiple%20Techniques_files/bootstrap.min.js"></script>
        <link rel="preload" as="style" href="Anti-Debugging%20-%20Multiple%20Techniques_files/app.4474f4d1.css"><link rel="modulepreload" href="Anti-Debugging%20-%20Multiple%20Techniques_files/app.5f3af5ce.js"><link rel="stylesheet" href="Anti-Debugging%20-%20Multiple%20Techniques_files/app.4474f4d1.css"><script type="module" src="Anti-Debugging%20-%20Multiple%20Techniques_files/app.5f3af5ce.js"></script><script src="Anti-Debugging%20-%20Multiple%20Techniques_files/navbar.js"></script>
<script src="Anti-Debugging%20-%20Multiple%20Techniques_files/moduleviewer.js"></script>

 
<script>
$(document).ready(function() {
    $('a:not([data-target="_self"])').attr('target', '_blank');

    $('input[type=checkbox]').change(function() {
    var checked = $(this).is(':checked');
    var userId = 260;
    var moduleId = 71;
    var objectiveId = $(this).data('objective-id');
    $.ajax({
        url: checked ? "https://maldevacademy.com/complete/objective" : "https://maldevacademy.com/remove/objective",
        type: "POST",
        data: {
        _token: "YwmJrjvrFLFoheCqdySsfQHrDWEGzxTLXO7qfost",
        user_id: userId,
        module_id: moduleId,
        objective_id: objectiveId
        },
        success: function(response) {

        },
        error: function(xhr) {
        console.log('Error');
        }
    });
    });

    $('#complete-module').submit(function(event) {
    event.preventDefault(); // Prevent default form submission

    var form = $(this);
    var url = form.attr('action');
    var data = form.serialize();
    var completeBtn = form.find('#complete-btn');
    var uncompleteBtn = $('#uncomplete-btn');

    $.ajax({
        type: 'POST',
        url: url,
        data: data,
        success: function(response) {
            completeBtn.addClass('hidden');
            uncompleteBtn.removeClass('hidden');
        },
        error: function(xhr) {
            console.log('Error');
        }
    });
});

$('#uncomplete-module').submit(function(event) {
    event.preventDefault(); // Prevent default form submission

    var form = $(this);
    var url = form.attr('action');
    var data = form.serialize();
    var completeBtn = $('#complete-btn');
    var uncompleteBtn = form.find('#uncomplete-btn');

    $.ajax({
        type: 'POST',
        url: url,
        data: data,
        success: function(response) {
            uncompleteBtn.addClass('hidden');
            completeBtn.removeClass('hidden');
        },
        error: function(xhr) {
            console.log('Error');
        }
    });
});
});
</script>
    
</a></body></html>